<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  background-color: #ccc;
}

div#svg {
   width: 400px;
}

.provincias path {
  fill: none;
  stroke: #fff;
  stroke-width: 2;
  stroke-linejoin: round;
}

.departamentos path {
  stroke: #fff;
  stroke-width: 1px;
}

.departamento:hover {
  cursor: pointer;
}


.q0-9 { fill:rgb(247,251,255); background-color: rgb(247,251,255); }
.q1-9 { fill:rgb(222,235,247); background-color: rgb(222,235,247); }
.q2-9 { fill:rgb(198,219,239); background-color: rgb(198,219,239); }
.q3-9 { fill:rgb(158,202,225); background-color: rgb(158,202,225); }
.q4-9 { fill:rgb(107,174,214); background-color: rgb(107,174,214); }
.q5-9 { fill:rgb(66,146,198);  background-color: rgb(66,146,198); }
.q6-9 { fill:rgb(33,113,181);  background-color: rgb(33,113,181); }
.q7-9 { fill:rgb(8,81,156); background-color: rgb(8,81,156); }
.q8-9 { fill:rgb(8,48,107); background-color: rgb(8,48,107); }

#distrito-info {
  width: 300px;
  border: 1px solid black;
  min-height: 200px;
  position: fixed;
  left: 700px; top: 50px;
  padding: 5px;
  background-color: #eeeeee;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  visibility: hidden;
}

  #distrito-info h3, #distrito-info h4 {
    text-transform: capitalize;
  }

.departamentos g.inactive {
  opacity: 0.2;
}


#choropleth-legend {

}

</style>
<body>
  <div>
  <select id="variable">
    <option value="Poblacion_Densidad_2001">Poblacion_Densidad_2001</option>
    <option value="Poblacion_Densidad_2010">Poblacion_Densidad_2010</option>
    <option value="Poblacion_Total_2001">Poblacion_Total_2001</option>
    <option value="Poblacion_Total_2010">Poblacion_Total_2010</option>
    <option value="Poblacion_Varones_2001">Poblacion_Varones_2001</option>
    <option value="Poblacion_Varones_2010">Poblacion_Varones_2010</option>
    <option value="Poblacion_Mujeres_2001">Poblacion_Mujeres_2001</option>
    <option value="Poblacion_Mujeres_2010">Poblacion_Mujeres_2010</option>
    <option value="Poblacion_Analfabetos_2001">Poblacion_Analfabetos_2001</option>
    <option value="Poblacion_Analfabetos_2010">Poblacion_Analfabetos_2010</option>
    <option value="Poblacion_Alfabetos_2001">Poblacion_Alfabetos_2001</option>
    <option value="Poblacion_Alfabetos_2010">Poblacion_Alfabetos_2010</option>
    <option value="Poblacion_0a14_2001">Poblacion_0a14_2001</option>
    <option value="Poblacion_0a14_2010">Poblacion_0a14_2010</option>
    <option value="Poblacion_15a64_2001">Poblacion_15a64_2001</option>
    <option value="Poblacion_15a64_2010">Poblacion_15a64_2010</option>
    <option value="Poblacion_65ymas_2001">Poblacion_65ymas_2001</option>
    <option value="Poblacion_65ymas_2010">Poblacion_65ymas_2010</option>
    <option value="Poblacion_Nacida_Extranjero_2001">Poblacion_Nacida_Extranjero_2001</option>
    <option value="Poblacion_Nacida_Extranjero_2010">Poblacion_Nacida_Extranjero_2010</option>
    <option value="Poblacion_Nacida_Argentina_2001">Poblacion_Nacida_Argentina_2001</option>
    <option value="Poblacion_Nacida_Argentina_2010">Poblacion_Nacida_Argentina_2010</option>
    <option value="Hogares_Total_2001">Hogares_Total_2001</option>
    <option value="Hogares_Total_2010">Hogares_Total_2010</option>
    <option value="Hogares_Con_Bano_2001">Hogares_Con_Bano_2001</option>
    <option value="Hogares_Con_Bano_2010">Hogares_Con_Bano_2010</option>
    <option value="Hogares_Sin_Bano_2001">Hogares_Sin_Bano_2001</option>
    <option value="Hogares_Sin_Bano_2010">Hogares_Sin_Bano_2010</option>
    <option value="Hogares_Con_Gas_Corriente_2001">Hogares_Con_Gas_Corriente_2001</option>
    <option value="Hogares_Con_Gas_Corriente_2010">Hogares_Con_Gas_Corriente_2010</option>
    <option value="Hogares_Sin_Gas_Corriente_2001">Hogares_Sin_Gas_Corriente_2001</option>
    <option value="Hogares_Sin_Gas_Corriente_2010">Hogares_Sin_Gas_Corriente_2010</option>
    <option value="Hogares_Con_Agua_Corriente_2001">Hogares_Con_Agua_Corriente_2001</option>
    <option value="Hogares_Con_Agua_Corriente_2010">Hogares_Con_Agua_Corriente_2010</option>
    <option value="Hogares_Sin_Agua_Corriente_2001">Hogares_Sin_Agua_Corriente_2001</option>
    <option value="Hogares_Sin_Agua_Corriente_2010">Hogares_Sin_Agua_Corriente_2010</option>
    <option value="Hogares_Con_Heladera_2001">Hogares_Con_Heladera_2001</option>
    <option value="Hogares_Con_Heladera_2010">Hogares_Con_Heladera_2010</option>
    <option value="Hogares_Sin_Heladera_2001">Hogares_Sin_Heladera_2001</option>
    <option value="Hogares_Sin_Heladera_2010">Hogares_Sin_Heladera_2010</option>
    <option value="Hogares_Con_Telefono_Linea_2001">Hogares_Con_Telefono_Linea_2001</option>
    <option value="Hogares_Con_Telefono_Linea_2010">Hogares_Con_Telefono_Linea_2010</option>
    <option value="Hogares_Sin_Telefono_Linea_2001">Hogares_Sin_Telefono_Linea_2001</option>
    <option value="Hogares_Sin_Telefono_Linea_2010">Hogares_Sin_Telefono_Linea_2010</option>
    <option value="Hogares_Con_Celular_2001">Hogares_Con_Celular_2001</option>
    <option value="Hogares_Con_Celular_2010">Hogares_Con_Celular_2010</option>
    <option value="Hogares_Sin_Celular_2001">Hogares_Sin_Celular_2001</option>
    <option value="Hogares_Sin_Celular_2010">Hogares_Sin_Celular_2010</option>
    <option value="Hogares_Sin_Computadora_2001">Hogares_Sin_Computadora_2001</option>
    <option value="Hogares_Sin_Computadora_2010">Hogares_Sin_Computadora_2010</option>
    <option value="Hogares_Con_Computadora_2001">Hogares_Con_Computadora_2001</option>
    <option value="Hogares_Con_Computadora_2010">Hogares_Con_Computadora_2010</option>
    <option value="Viviendas_Total_2001">Viviendas_Total_2001</option>
    <option value="Viviendas_Total_2010">Viviendas_Total_2010</option>
    <option value="Viviendas_Casa_2001">Viviendas_Casa_2001</option>
    <option value="Viviendas_Casa_2010">Viviendas_Casa_2010</option>
    <option value="Viviendas_Rancho_2001">Viviendas_Rancho_2001</option>
    <option value="Viviendas_Rancho_2010">Viviendas_Rancho_2010</option>
    <option value="Viviendas_Casilla_2001">Viviendas_Casilla_2001</option>
    <option value="Viviendas_Casilla_2010">Viviendas_Casilla_2010</option>
    <option value="Viviendas_Departamento_2001">Viviendas_Departamento_2001</option>
    <option value="Viviendas_Departamento_2010">Viviendas_Departamento_2010</option>
    <option value="Viviendas_Pieza_Inquilinato_2001">Viviendas_Pieza_Inquilinato_2001</option>
    <option value="Viviendas_Pieza_Inquilinato_2010">Viviendas_Pieza_Inquilinato_2010</option>
    <option value="Viviendas_Pieza_Hotel_Pension_2001">Viviendas_Pieza_Hotel_Pension_2001</option>
    <option value="Viviendas_Pieza_Hotel_Pension_2010">Viviendas_Pieza_Hotel_Pension_2010</option>
    <option value="Viviendas_Local_No_Construido_Para_habitacion_2001">Viviendas_Local_No_Construido_Para_habitacion_2001</option>
    <option value="Viviendas_Local_No_Construido_Para_habitacion_2010">Viviendas_Local_No_Construido_Para_habitacion_2010</option>
    <option value="Viviendas_movil_2001">Viviendas_movil_2001</option>
    <option value="Viviendas_movil_2010">Viviendas_movil_2010</option>
  </select>
<img src="img/spinner.gif" width="80" height="10" style="visibility: hidden" id="spinner">
<select id="provincia">
  <option value="BUENOS AIRES">BUENOS AIRES</option>
  <option value="CAPITAL FEDERAL">CAPITAL FEDERAL</option>
  <option value="CATAMARCA">CATAMARCA</option>
  <option value="CHACO">CHACO</option>
  <option value="CHUBUT">CHUBUT</option>
  <option value="CORDOBA">CORDOBA</option>
  <option value="CORRIENTES">CORRIENTES</option>
  <option value="ENTRE RIOS">ENTRE RIOS</option>
  <option value="FORMOSA">FORMOSA</option>
  <option value="ISLAS MALVINAS">ISLAS MALVINAS</option>
  <option value="JUJUY">JUJUY</option>
  <option value="LA PAMPA">LA PAMPA</option>
  <option value="LA RIOJA">LA RIOJA</option>
  <option value="MENDOZA">MENDOZA</option>
  <option value="MISIONES">MISIONES</option>
  <option value="NEUQUEN">NEUQUEN</option>
  <option value="RIO NEGRO">RIO NEGRO</option>
  <option value="SALTA">SALTA</option>
  <option value="SAN JUAN">SAN JUAN</option>
  <option value="SAN LUIS">SAN LUIS</option>
  <option value="SANTA CRUZ">SANTA CRUZ</option>
  <option value="SANTA FE">SANTA FE</option>
  <option value="SANTIAGO DEL ESTERO">SANTIAGO DEL ESTERO</option>
  <option value="TIERRA DEL FUEGO">TIERRA DEL FUEGO</option>
  <option value="TUCUMAN">TUCUMAN</option>
</select>
</div>
  <div id="svg"></div>

<!--[if lte IE 8]><script src="js/r2d3.js" charset="utf-8"></script><![endif]-->
<!--[if gte IE 9]><!-->
<script src="js/d3.v3.js"></script>
<!--<![endif]-->
<script src="js/topojson.v0.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/handlebars.js"></script>
<script src="js/ftclient.js"></script>
<script id="distrito-info-template" type="text/x-handlebars-template">
  <h3>{{ lower DEPARTAMEN}}</h3>
  <h4>{{ lower PROVINCIA}}</h3>
  <p><strong>{{variable_name}}</strong>: {{variable_value}}
</script>

<script>
// i need this.
Object.extend = function(destination, source) {
    for (var property in source) {
        if (source.hasOwnProperty(property)) {
            destination[property] = source[property];
        }
    }
    return destination;
};


var to_id = function(str) {
    return str.replace(/\s+/g, '-').toLowerCase();
};

var FT_CENSO = '1LLUZN9UWi_et0W8GVeRw_QwCkP_JUIgrfjIA8ec';
var FT_API_KEY = 'AIzaSyBrM8jb4-i5xxm0uPZtEUaQSD8JbsKiY3E';

var DISTRITO_INFO_TMPL = Handlebars.compile(d3.select('#distrito-info-template').html());
var ftclient = new FTClient(FT_CENSO, FT_API_KEY);

var currentVariable;
var currentDataDict;

Handlebars.registerHelper('lower', function(str) {
    return str.toLowerCase();
});


var showDistritoInfo = function(d) {
    var di = d3.select('#distrito-info');
    di.html(
        DISTRITO_INFO_TMPL(Object.extend(
            {
                variable_name: currentVariable,
                variable_value: currentDataDict[d.id]
            },
            d.properties)));
    di.style('visibility', 'visible');
};

var hideDistritoInfo = function(d) {
    var di = d3.select('#distrito-info');
    di.style('visibility', 'hidden');
};

var width = 400,
    height = 1000;

var projection = d3.geo.mercator()
        .scale(7000)
        .center([-64,-32])
        .translate([200,300]);

var path = d3.geo.path().projection(projection);

var svg = d3.select("div#svg").append("svg")
        .attr("width", width)
        .attr("height", height);

var departamentos = svg.append('g').attr('class', 'departamentos');
var provincias =  svg.append('g').attr('class', 'provincias');
var legend = svg.append('g').attr('class', 'legend');

var compressRange = function(scale, ary){
    var start = scale.domain()[0], end = scale.domain()[1];
    var rv = [{ start: start, end: ary[0].x, color: ary[0].color }];
    for(var i = 1; i < ary.length; i++) {
        rv[rv.length - 1].end = ary[i].x;
        if (ary[i].color != rv[rv.length - 1].color)
            rv.push({start: ary[i].x, end: ary[i].x, color: ary[i].color });
    }
    rv[rv.length - 1].end = end;
    console.log(rv);
    return rv;
};

var drawLegend = function(scale, quantizer) {
    var ticks = scale.ticks();
    legend.selectAll('rect')
          .data(compressRange(scale, ticks.map(function(t) {
              return { x: t, color: quantizer(t) };
          })))
          .enter()
          .append('rect')
          .attr('x', function(d, i) { console.log(d, i); return 10; })
          .attr('width', 20)
          .attr('class', 'caca');
};

// Dibujar el mapa para la variable `variable_name`
var drawMap = function(variable_name) {
    var spinner = d3.select('img#spinner');
    spinner.style('visibility', 'visible');
    currentVariable = variable_name;

    ftclient.getVariable(currentVariable, function(values) {

        // buscar maximo y minimo valor
        var values_array = d3.entries(values).map(function(v) {
            return parseFloat(v.value);
        });
        var min = d3.min(values_array), max = d3.max(values_array);

        // construir escala logaritmica y quantizador
        var scale = d3.scale.log()
                .clamp(true)
                .domain([min == 0 ? 0.1 : min, max])
                .nice();

        var quantize = d3.scale.quantize()
                .domain([scale(min), scale(max)])
                .range(d3.range(9).map(function(i) {
                    var c = Math.floor(i/(9/3)) * (9/3);
                    return "q" + c + "-9";
                }));

        drawLegend(scale, quantize);

        currentDataDict = values;
        // pintar el mapa
        departamentos
            .selectAll('path')
            .attr('class', function(d) { return quantize(scale(parseFloat(values[d.id]))); });

        spinner.style('visibility', 'hidden');
    });

};

d3.json('ea.json', function(error, topology) {
    var provincias_geometries = topojson.object(topology, topology.objects.provincias).geometries;
    var departamentos_geometries =  topojson.object(topology, topology.objects.departamentos).geometries;

    provincias
        .selectAll('path')
        .data(provincias_geometries)
        .enter()
        .append('path')
        .attr('id', function(d) { return to_id(d.properties.PROVINCIA); })
        .attr('d', path)
        .attr('class', 'provincia');

    provincias_geometries.forEach(function(pg) {
        p_id = to_id(pg.properties.PROVINCIA);
        departamentos
            .append('g')
            .attr('id', 'provincia-' + p_id)
            .selectAll('path')
            .data(departamentos_geometries.filter(function(d) { return p_id === to_id(d.properties.PROVINCIA); }))
            .enter()
            .append('path')
            .attr('id', function(d) { return d.id })
            .attr('d', path)
            .attr('class', 'departamento')
            .on('mouseover', showDistritoInfo)
            .on('mouseout', hideDistritoInfo)
            .on('click', function(p) { console.log(p); });
    });
});

// onChange handler for select
d3.select('select#variable').on('change', function() {
    drawMap(this.value);
});

d3.select('select#provincia').on('change', function() {
    var v = this.value;
    var p = d3.select('.provincias path#' + to_id(v));

    svg.selectAll('g.departamentos g').classed('inactive', false);

    var p_bbox = p[0][0].getBBox();
    var provincias_bbox = provincias[0][0].getBBox();
    var x = -(p_bbox.x + p_bbox.width/2),
        y = -(p_bbox.y + p_bbox.height/2),
        k = provincias_bbox.width / p_bbox.width;

    svg.selectAll('g.provincias, g.departamentos').transition().duration(1000)
        .attr("transform", "scale("+k+")translate(" + (x+projection.translate()[0] / k) + "," + (y+projection.translate()[1]/k) + ")")
        .selectAll('path')
        .style("stroke-width", 2 / k + "px");

    svg.selectAll('g.departamentos g:not(#provincia-' + to_id(v) + ')').classed('inactive', true);
});

$(function() {
    drawMap(d3.select('select#variable')[0][0].value);
});
</script>
<div id="distrito-info"></div>
<div id="choropleth-legend">
</div>
</body>
